{% extends "base.html" %}
{% block title %}Feed - TwINSA{% endblock %}

{% block content %}

<style>
  /* --- Notifications sidebar --- */
  .notif-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1100;
    border: none;
    background: #111827;
    color: #f9fafb;
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    cursor: pointer;
    font-size: 1.1rem;
  }

  .notif-sidebar {
    position: fixed;
    top: 0;
    left: -260px;
    width: 260px;
    height: 100vh;
    background: #111827;
    color: #f9fafb;
    padding: 1rem;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    transition: left 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
  }

  .notif-sidebar.open {
    left: 0;
  }
</style>

<!-- üîî Bell -->
<button class="notif-toggle" id="notifToggle">üîî</button>

<!-- Sidebar -->
<aside class="notif-sidebar" id="notifSidebar">
  <div class="notif-sidebar-header">
    <h3>Notifications</h3>
    <span class="notif-count">{{ notifications|length }}</span>
  </div>

  <ul class="notif-list">
    {% if notifications %}
      {% for n in notifications %}
        <li class="notif-item">{{ n }}</li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No notifications yet.</li>
    {% endif %}
  </ul>

  <div class="notif-sidebar-header" style="margin-top: 1rem;">
    <h3>Pending requests</h3>
    <span class="notif-count">{{ pending_requests|length }}</span>
  </div>

  <ul class="notif-list">
    {% if pending_requests %}
      {% for u in pending_requests %}
        <li class="notif-item">
          {% if u.username is defined %}
            {{ u.username }} wants to follow you
          {% else %}
            {{ u }} wants to follow you
          {% endif %}
        </li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No pending requests.</li>
    {% endif %}
  </ul>
</aside>

<div class="feed-main-with-notifs">

  <!-- üîµ HEADER -->
  <div class="feed-header-top">
    <h2>Welcome, {{ username }} üëã</h2>

    <div class="feed-header-buttons">
      <!-- Search devient bleu : profile-btn -->
      <a href="{{ url_for('search_users') }}" class="btn profile-btn">Search</a>

      <!-- Profile reste bleu -->
      <a href="{{ url_for('profile', username=username) }}" class="btn profile-btn">Profile</a>

      <!-- Logout reste normal -->
      <a href="{{ url_for('logout') }}" class="btn logout-btn">Log out</a>
    </div>
  </div>

  <div class="feed-container">

    <!-- FORMULAIRE POUR PUBLIER UN TWEET -->
    <form method="POST" class="tweet-form" id="tweetForm" enctype="multipart/form-data">
      <textarea id="tweetBox" name="tweet" maxlength="180" placeholder="What's happening?" required></textarea>
      <input type="file" name="image" accept=".jpg,.jpeg,.png">
      <div class="tweet-footer">
        <span id="charCount">0 / 180</span>
        <button type="submit">Post</button>
      </div>
    </form>

    <hr>

    <!-- AFFICHAGE DES TWEETS -->
    <div class="tweets">
      {% if tweets %}
        {% for tweet in tweets %}
          <div class="tweet">

            <div class="tweet-header">
              <a href="{{ url_for('profile', username=tweet.poster_username) }}">
                <img src="{{ url_for('static', filename='profile_pics/' ~ tweet.poster_pfp) }}"
                class="pfp-small" alt="pfp">
              </a>
              <strong>@{{ tweet.poster_username }}</strong>
            </div>

            <p>{{ tweet.content }}</p>

            {% if tweet.image %}
              <img src="{{ url_for('static', filename='uploads/' ~ tweet.image) }}" 
                 alt="Post image" style="max-width: 300px; display:block; margin-top:0.5rem;">
            {% endif %}    
              

            <small>{{ tweet.date }}</small>

            <div class="tweet-actions">
              <a href="{{ url_for('like', post_index=loop.index0) }}" class="like-btn">
                ‚ù§Ô∏è {{ tweet.likes|length }}
              </a>
              <form action="{{ url_for('delete_post_route', post_index=tweet.index) }}" method="POST" style="display:inline;">
                 <button type="submit" class="delete-btn">üóëÔ∏è Delete</button>
              </form>

              <form action="{{ url_for('edit_post_route', post_index=tweet.index) }}" method="POST" class="edit-form" style="display:none;">
                <input type="text" name="new_content" value="{{ tweet.content }}" maxlength="180" required>
                <button type="submit" class="save-edit-btn">üíæ Save</button>
              </form>

              <button class="edit-btn" onclick="toggleEdit(this)">‚úèÔ∏è Edit</button>
            </div>

            <div class="tweet-comments">
              {% if tweet.comments %}
                {% for c in tweet.comments %}
                  <div class="comment">
                    <div class="comment-header">
                      <strong>@{{ c.username }}</strong>
                      {% if c.username == username %}
                        <a href="{{ url_for('delete_comment', post_index=tweet.index, comment_index=loop.index0) }}" class="delete-comment">üóëÔ∏è</a>
                      {% endif %}
                    </div>
                    <p>{{ c.comment }}</p>
                    <small>{{ c.date }}</small>
                  </div>
                {% endfor %}
              {% endif %}

              <form action="{{ url_for('comment', post_index=loop.index0) }}" method="POST" class="comment-form">
                <input type="text" name="comment" placeholder="Add a comment..." maxlength="120">
                <button type="submit" class="comment-btn">üí¨</button>
              </form>
            </div>

          </div>
        {% endfor %}
      {% else %}
        <p>No posts yet. Be the first to post!</p>
      {% endif %}
    </div>

  </div>
</div>

<script>
  // Sidebar toggle
  const notifToggle = document.getElementById('notifToggle');
  const notifSidebar = document.getElementById('notifSidebar');

  notifToggle.addEventListener('click', () => {
    notifSidebar.classList.toggle('open');
  });

  // Char count
  const tweetBox = document.getElementById('tweetBox');
  const charCount = document.getElementById('charCount');

  tweetBox.addEventListener('input', () => {
    charCount.textContent = tweetBox.value.length + " / 180";
  });
</script>

<script>
function toggleEdit(btn) {
  const tweet = btn.closest(".tweet");
  const form = tweet.querySelector(".edit-form");
  form.style.display = form.style.display === "none" ? "block" : "none";
}
</script>

{% endblock %}
