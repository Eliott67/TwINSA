{% extends "base.html" %}
{% block title %}Search Users - TwINSA{% endblock %}

{% block content %}
<h1>Search Users</h1>

<div class="search-header">
  <a href="{{ url_for('feed') }}" class="btn back-btn">‚Üê Back to Feed</a>
</div>

<form method="POST" class="search-form">
    <input type="text" name="query" placeholder="Search users..." required>
    <button type="submit">üîç Search</button>
</form>

{% if history %}
<h3>Recent Searches:</h3>
<ul>
    {% for h in history %}
    <li>{{ h }}</li>
    {% endfor %}
</ul>
  <form action="{{ url_for('clear_search_history') }}" method="POST">
      <button type="submit" class="btn-clear">Clear History</button>
  </form>
{% endif %}

{% if results %}
<h3>Results:</h3>
<ul>
    {% for u in results %}
    <li>
        {{ u.username }} 
        {% if current_user.follows(u) %}
            (Followed)
        {% endif %}
        - <a href="{{ url_for('view_profile', username=u.username) }}">View Profile</a>
        {% if not current_user.follows(u) and u.username != current_user.username %}
        - <form action="{{ url_for('follow_user', username=u.username) }}"
            method="POST"
            style="display:inline;">
            <button type="submit" class="btn-link">Follow</button>
        </form>

       {% endif %}

        {% if u.username != current_user.username %}
            {% if current_user.follows(u) %}
            <!-- Unfollow form -->
            <form action="{{ url_for('unfollow_user', username=u.username) }}" method="POST" style="display:inline;">
                <button type="submit">Unfollow</button>
            </form>
            {% else %}
                {% if u.is_public %}
                    <!-- Follow form -->
                    <form action="{{ url_for('follow_user', username=u.username) }}" method="POST" style="display:inline;">
                        <button type="submit">Follow</button>
                    </form>
                {% else %}
                    <!-- Private user: Send follow request -->
                    <form action="{{ url_for('send_follow_request', username=u.username) }}" method="POST" style="display:inline;">
                        <button type="submit">Send follow request</button>
                    </form>
                {% endif %}
            {% endif %}
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% endif %}

<ul id="suggestions" class="suggestions-list"></ul>

<script>
const input = document.querySelector('input[name="query"]');
const suggestionsList = document.getElementById("suggestions");

input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (q.length === 0) {
        suggestionsList.innerHTML = "";
        return;
    }

    const res = await fetch(`/api/search_suggestions?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    suggestionsList.innerHTML = "";
    data.results.forEach(user => {
        const li = document.createElement("li");
        li.innerHTML = `<a href="/view_profile/${user}">${user}</a>`;
        suggestionsList.appendChild(li);
    });
});
</script>

{% endblock %}