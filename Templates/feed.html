{% extends "base.html" %}
{% block title %}Feed - TwINSA{% endblock %}

{% block content %}


<style>
  /* --- Notifications sidebar --- */
  .notif-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1100;
    border: none;
    background: #111827;
    color: #f9fafb;
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    cursor: pointer;
    font-size: 1.1rem;
  }

  .notif-sidebar {
    position: fixed;
    top: 0;
    left: -260px; /* hidden by default */
    width: 260px;
    height: 100vh;
    background: #111827;
    color: #f9fafb;
    padding: 1rem;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    transition: left 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
  }

  .notif-sidebar.open {
    left: 0;
  }

  .notif-sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .notif-sidebar-header h3 {
    margin: 0;
    font-size: 1.1rem;
  }

  .notif-count {
    background: #f97316;
    border-radius: 999px;
    padding: 0.1rem 0.6rem;
    font-size: 0.8rem;
  }

  .notif-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .notif-item {
    padding: 0.6rem 0.4rem;
    border-bottom: 1px solid rgba(249,250,251,0.1);
    font-size: 0.9rem;
    line-height: 1.3;
  }

  .notif-item:last-child {
    border-bottom: none;
  }

  .notif-empty {
    padding: 0.4rem;
    font-size: 0.9rem;
    color: #9ca3af;
  }

  /* Just moves your feed a bit to the right so it‚Äôs not under the bell */
  .feed-main-with-notifs {
    padding-left: 3.5rem;
  }

  @media (max-width: 600px) {
    .feed-main-with-notifs {
      padding-left: 3rem;
    }
  }


  .pending-item {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .request-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: 0.3rem;
  }

  .btn-accept,
  .btn-reject,
  .btn-follow-back {
    border: none;
    padding: 0.25rem 0.7rem;
    border-radius: 999px;
    font-size: 0.8rem;
    cursor: pointer;
    font-weight: 500;
    transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    white-space: nowrap;
  }

  .btn-accept {
    background: #22c55e;
    color: #111827;
    box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
  }

  .btn-reject {
    background: #ef4444;
    color: #f9fafb;
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
  }

  .btn-follow-back {
    background: #0ea5e9;
    color: #0b1120;
    box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
  }

  .btn-accept:hover,
  .btn-reject:hover,
  .btn-follow-back:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.35);
  }

  .btn-accept:active,
  .btn-reject:active,
  .btn-follow-back:active {
    transform: translateY(0);
    box-shadow: none;
    opacity: 0.9;
  }

</style>


<!-- üîî Bell to open the sidebar -->
<button class="notif-toggle" id="notifToggle">üîî</button>

<!-- Left sliding sidebar -->
<aside class="notif-sidebar" id="notifSidebar">
  <div class="notif-sidebar-header">
    <h3>Notifications</h3>
    <span class="notif-count">{{ notifications|length }}</span>
  </div>

  <ul class="notif-list">
    {% if notifications %}
      {% for n in notifications %}
        <li class="notif-item">{{ n }}</li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No notifications yet.</li>
    {% endif %}
  </ul>

    <!-- Pending follow requests section -->
    <!-- Pending follow requests section -->
  <div class="notif-sidebar-header" style="margin-top: 1rem;">
    <h3>Pending requests</h3>
    <span class="notif-count" id="pendingCount">{{ pending_requests|length }}</span>
  </div>

  <ul class="notif-list" id="pendingList">
    {% if pending_requests %}
      {% for u in pending_requests %}
        {% if u.username is defined %}
          {% set uname = u.username %}
        {% else %}
          {% set uname = u %}
        {% endif %}
        <li class="notif-item pending-item" data-username="{{ uname }}">
          <span class="pending-text">
            {{ uname }} wants to follow you
          </span>
          <div class="request-actions">
            <button type="button" class="btn-accept">Accept</button>
            <button type="button" class="btn-reject">Reject</button>
            <button type="button" class="btn-follow-back" style="display:none;">
              Follow back
            </button>
          </div>
        </li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No pending requests.</li>
    {% endif %}
  </ul>



</aside>

<!-- üëá NEW wrapper, your existing feed goes inside -->
<div class="feed-main-with-notifs">


  <!-- Barre du haut avec boutons profil et log out et recherche -->
  <div class="feed-header-top">
    <h2>Welcome, {{ username }} üëã</h2>
    <div class="feed-header-buttons">
      <a href="{{ url_for('profile', username=username) }}" class="btn profile-btn">Profile</a>
      <a href="{{ url_for('search_users') }}" class="btn search-btn">Search</a>
      <a href="{{ url_for('logout') }}" class="btn logout-btn">Log out</a>
    </div>
  </div>

  <div class="feed-container">
    <!-- Formulaire pour poster -->
    <form method="POST" class="tweet-form" id="tweetForm">
      <textarea id="tweetBox" name="tweet" maxlength="180" placeholder="What's happening?" required></textarea>
      <div class="tweet-footer">
        <span id="charCount">0 / 180</span>
        <button type="submit">Post</button>
      </div>
    </form>

    <hr>

    <!-- Liste des posts -->
    <div class="tweets">
      {% if tweets %}
        {% for tweet in tweets %}
          {% set _ = tweet.update({'index': loop.index0}) %}
          <div class="tweet">
            <strong>@{{ tweet.poster_username }}</strong>
            <p>{{ tweet.content }}</p>
            <small>{{ tweet.date }}</small>

            <!-- Zone de likes -->
            <div class="tweet-actions">
              <a href="{{ url_for('like', post_index=loop.index0) }}" class="like-btn">
                ‚ù§Ô∏è {{ tweet.likes|length }}
              </a>
              {% if true %}
              <button class="edit-btn">‚úèÔ∏è Edit</button>
              <button class="delete-btn">üóëÔ∏è Delete</button>
              {% endif %}
            </div>

            <!-- Zone de commentaires -->
            <div class="tweet-comments">
              {% if tweet.comments %}
                {% for c in tweet.comments %}
                  <div class="comment">
                    <div class="comment-header">
                      <strong>@{{ c.username }}</strong>
                      {% if c.username == username %}
                        <a href="{{ url_for('delete_comment', post_index=tweet.index, comment_index=loop.index0) }}" class="delete-comment">üóëÔ∏è</a>
                      {% endif %}
                    </div>
                    <p>{{ c.comment }}</p>
                    <small>{{ c.date }}</small>
                  </div>
                {% endfor %}
              {% endif %}

              <!-- Formulaire de commentaire -->
              <form action="{{ url_for('comment', post_index=loop.index0) }}" method="POST" class="comment-form">
                <input type="text" name="comment" placeholder="Add a comment..." maxlength="120">
                <button type="submit" class="comment-btn">üí¨</button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p>No posts yet. Be the first to post!</p>
      {% endif %}
    </div>
  </div>
</div> 

<!-- Script principal -->
<script>
  // --- Sidebar toggle ---
  const notifToggle = document.getElementById('notifToggle');
  const notifSidebar = document.getElementById('notifSidebar');

  if (notifToggle && notifSidebar) {
    notifToggle.addEventListener('click', () => {
      notifSidebar.classList.toggle('open');
    });
  }

  // --- Compteur de caract√®res pour le tweet ---
  const tweetBox = document.getElementById('tweetBox');
  const charCount = document.getElementById('charCount');

  if (tweetBox && charCount) {
    tweetBox.addEventListener('input', () => {
      const length = tweetBox.value.length;
      charCount.textContent = `${length} / 180`;
      charCount.style.color = length > 160 ? '#ff4d4d' : '#aaa';
    });
  }

  // --- Edit / Delete posts ---
  document.querySelectorAll('.tweet').forEach(tweetDiv => {
    const contentP = tweetDiv.querySelector('p'); // le contenu du post
    const editBtn = tweetDiv.querySelector('.edit-btn');
    const deleteBtn = tweetDiv.querySelector('.delete-btn');

    if (editBtn) {
      editBtn.addEventListener('click', () => {
        const newContent = prompt("Edit your post:", contentP.textContent);
        if (newContent !== null && newContent.trim() !== "") {
          contentP.textContent = newContent;
          alert("Post mis √† jour !");
          // TODO : connecter √† ton backend Python pour sauvegarder
        }
      });
    }

    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (confirm("Confirmez la suppression ?")) {
          tweetDiv.remove();
          alert("Post supprim√© !");
          // TODO : connecter √† ton backend Python pour supprimer le post
        }
      });
    }
  });

  // --- Pending requests: Accept / Reject / Follow back ---
  const pendingList = document.getElementById('pendingList');
  const pendingCountSpan = document.getElementById('pendingCount');

  function refreshPendingCount() {
    if (!pendingList || !pendingCountSpan) return;
    const activePending = pendingList.querySelectorAll('.pending-item').length;
    pendingCountSpan.textContent = activePending;
  }

  if (pendingList) {
    pendingList.querySelectorAll('.pending-item').forEach(item => {
      const username = item.dataset.username;
      const textSpan = item.querySelector('.pending-text');
      const acceptBtn = item.querySelector('.btn-accept');
      const rejectBtn = item.querySelector('.btn-reject');
      const followBackBtn = item.querySelector('.btn-follow-back');

      // --- ACCEPT ---
      if (acceptBtn) {
        acceptBtn.addEventListener('click', () => {
          fetch("{{ url_for('accept_request') }}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ username: username })
          })
          .then(res => res.json())
          .then(data => {
            if (data.status === "ok") {
              // UI only after backend success
              textSpan.textContent = `${username} now follows you`;
              acceptBtn.style.display = 'none';
              if (rejectBtn) rejectBtn.style.display = 'none';
              if (followBackBtn) followBackBtn.style.display = 'inline-flex';

              // plus "pending" -> remove class + update counter
              item.classList.remove('pending-item');
              refreshPendingCount();
            } else {
              alert(data.message || "Error accepting request");
            }
          })
          .catch(err => {
            console.error(err);
            alert("Network error while accepting request.");
          });
        });
      }

      // --- REJECT (front only, no backend route yet) ---
      if (rejectBtn) {
        rejectBtn.addEventListener('click', () => {
          if (!confirm(`Reject ${username}'s follow request ?`)) return;

          fetch("{{ url_for('reject_request') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: username })
          })
          .then(res => res.json())
          .then(data => {
            if (data.status === "ok") {
              item.remove();
              refreshPendingCount();
            } else {
              alert(data.message || "Error rejecting request");
            }
          })
          .catch(err => {
            console.error(err);
            alert("Network error while rejecting request.");
          });
        });
      }


      // --- FOLLOW BACK ---
      if (followBackBtn) {
        followBackBtn.addEventListener('click', () => {
          fetch("{{ url_for('follow_back') }}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ username: username })
          })
          .then(res => res.json())
          .then(data => {
            if (data.status === "ok") {
              // Target is public ‚Üí you now follow them
              followBackBtn.textContent = 'Following ‚úì';
            } else if (data.status === "pending") {
              // Target is private ‚Üí follow request sent
              followBackBtn.textContent = 'Request sent ‚úì';
            } else {
              alert(data.message || "Error following back");
              return;
            }

            followBackBtn.disabled = true;
            followBackBtn.style.opacity = '0.8';
          })
          .catch(err => {
            console.error(err);
            alert("Network error while following back.");
          });
        });
      }
    });

    // initialise le compteur au cas o√π le DOM change
    refreshPendingCount();
  }
</script>


{% endblock %}