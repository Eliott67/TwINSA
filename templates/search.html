{% extends "base.html" %}
{% block title %}Search Users - TwINSA{% endblock %}

{% block content %}

<style>
  .search-page {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1.5rem;
  }

  .search-top-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .search-title {
    margin: 0;
    font-size: 1.8rem;
  }

  .search-header .back-btn {
    font-size: 0.9rem;
  }

  /* üîµ Grosse barre centr√©e */
  .search-form {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0 auto;
    margin-bottom: 0.75rem;
    max-width: 600px;
  }

  .search-form input[name="query"] {
    flex: 1;
    padding: 0.7rem 1rem;
    border-radius: 999px;
    border: 1px solid #ddd;
    font-size: 1rem;
    outline: none;
  }

  .search-form input[name="query"]:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59,130,246,0.15);
  }

  /* IMPORTANT : on retire le bleu local pour laisser profile-btn faire le styling */
  .search-form button {
    border-radius: 999px;
    padding: 0.7rem 1.1rem;
    cursor: pointer;
    font-size: 0.95rem;
    white-space: nowrap;
    border: none;
  }

  /* Suggestions live */
  .suggestions-list {
    list-style: none;
    max-width: 600px;
    margin: 0.25rem auto 1.5rem auto;
    padding: 0;
    border-radius: 0.75rem;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
  }

  .suggestions-list li {
    padding: 0.4rem 0.8rem;
    color : #3B82F6 ;
    font-weight: 500;
  }

  .suggestions-list li a {
    text-decoration: none;
    color: #111827;
    display: block;
  }

  .suggestions-list li a:hover {
    text-decoration: underline;
  }

  /* Historique */
  .search-history {
    max-width: 600px;
    margin: 0 auto 1.5rem auto;
    font-size: 0.9rem;
  }

  .search-history h3 {
    margin-bottom: 0.4rem;
  }

  .search-history ul {
    list-style: none;
    padding-left: 0;
    margin: 0 0 0.5rem 0;
  }

  .search-history li {
    padding: 0.15rem 0;
    color: #4b5563;
  }

  .btn-clear {
    font-size: 0.8rem;
    border-radius: 999px;
    padding: 0.25rem 0.7rem;
    border: 1px solid #ef4444;
    color: #ef4444;
    background: #fff;
    cursor: pointer;
  }

  /* R√©sultats */
  .results-section {
    max-width: 800px;
    margin: 0 auto;
  }

  .results-section h3 {
    margin-bottom: 0.75rem;
  }

  .results-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }

  .user-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.7rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
    background: #ffffff;
  }

  .user-main {
    display: flex;
    flex-direction: column;
  }

  .user-username {
    font-weight: 600;
  }

  .user-tag {
    font-size: 0.8rem;
    color: #10b981;
    margin-left: 0.4rem;
  }

  .user-actions {
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .btn-view {
    background: #e5e7eb;
    color: #111827;
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
    font-size: 0.85rem;
  }

  .btn-follow {
    background: #3b82f6;
    color: #fff;
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
  }

  .btn-unfollow {
    background: #f87171;
    color: white;
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
  }

  .btn-request {
    background: #fbbf24;
    color: #111827;
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
  }

  #selected-hashtags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.selected-tag {
  background: #e5e7eb;
  padding: 0.3rem 0.7rem;
  border-radius: 999px;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-weight: bold;
  color : #3B82F6 ;
}

.selected-tag button {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  color: #6b7280;
}
.selected-tag button:hover {
  color: #111827;
}

</style>

<div class="search-page">

  <!-- Titre -->
  <div class="search-top-row">
    <h1 class="search-title">Search Users</h1>
    <div class="search-header">
      <a href="{{ url_for('feed') }}" class="btn back-btn">‚Üê Back to Feed</a>
    </div>
  </div>

  <!-- üîµ GROSSE BARRE DE RECHERCHE AVEC BOUTON BLEU -->
  <form method="POST" class="search-form">
    <input type="text" name="query" placeholder="Search users..." required>
    <button type="submit" class="btn profile-btn">üîç Search</button>
  </form>

  <!-- üîé Recherche de hashtags -->
<div class="search-form">
  <input type="text" id="hashtag-input" placeholder="Search hashtags...">
</div>

<!-- Suggestions hashtags -->
<ul id="hashtag-suggestions" class="suggestions-list"></ul>

<!-- Hashtags s√©lectionn√©s -->
<div id="selected-hashtags" style="margin-bottom: 1rem;"></div>

<button id="apply-hashtag-filter" class="btn profile-btn" style="display:none;">
  Filter Feed with selected hashtags
</button>


  <!-- Suggestions -->
  <ul id="suggestions" class="suggestions-list"></ul>

  <!-- Historique -->
  {% if history %}
  <div class="search-history">
    <h3>Recent Searches</h3>
    <ul>
      {% for h in history %}
      <li>{{ h }}</li>
      {% endfor %}
    </ul>
    <form action="{{ url_for('clear_search_history') }}" method="POST">
      <button type="submit" class="btn-clear">Clear History</button>
    </form>
  </div>
  {% endif %}

  <!-- R√©sultats -->
  {% if results %}
  <div class="results-section">
    <h3>Results</h3>

    <ul class="results-list">
      {% for u in results %}
      <li>
        <div class="user-card">
          
          <div class="user-main">
            <span class="user-username">
              {{ u.username }}
              {% if current_user.follows(u) %}
              <span class="user-tag">Followed</span>
              {% endif %}
            </span>
          </div>

          <div class="user-actions">

            <!-- View -->
            <a href="{{ url_for('profile', username=user.username, entry='search') }}">
              
            </a>

            <!-- Follow / Unfollow -->
            {% if u.username != current_user.username %}

              {% if current_user.follows(u) %}
              <form action="{{ url_for('unfollow_user', username=u.username) }}" method="POST">
                <button type="submit" class="btn-unfollow">Unfollow</button>
              </form>

              {% else %}
                {% if u.is_public %}
                <form action="{{ url_for('follow_user', username=u.username) }}" method="POST">
                  <button type="submit" class="btn-follow">Follow</button>
                </form>

                {% else %}
                <form action="{{ url_for('send_follow_request', username=u.username) }}" method="POST">
                  <button type="submit" class="btn-request">Request</button>
                </form>
                {% endif %}
              {% endif %}
            {% endif %}

          </div>

        </div>
      </li>
      {% endfor %}
    </ul>

  </div>
  {% endif %}

</div>

<script>
const input = document.querySelector('input[name="query"]');
const suggestionsList = document.getElementById("suggestions");

if (input) {
  input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (q.length === 0) {
      suggestionsList.innerHTML = "";
      return;
    }

    const res = await fetch(`/api/search_suggestions?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    suggestionsList.innerHTML = "";
    data.results.forEach(user => {
      const li = document.createElement("li");
      li.innerHTML = `<a href="/view_profile/${user}">${user}</a>`;
      suggestionsList.appendChild(li);
    });
  });
}
/* === üî• Hashtag search logic === */
const hashtagInput = document.getElementById("hashtag-input");
const hashtagSuggestions = document.getElementById("hashtag-suggestions");
const selectedDiv = document.getElementById("selected-hashtags");
const applyBtn = document.getElementById("apply-hashtag-filter");

let selectedTags = [];

if (hashtagInput) {
  hashtagInput.addEventListener("input", async () => {
    let q = hashtagInput.value.trim().toLowerCase();

    // on force le # au d√©but
    if (!q.startsWith("#")) q = "#" + q;

    if (q.length < 2) {
      hashtagSuggestions.innerHTML = "";
      return;
    }

    const res = await fetch(`/api/hashtag_suggestions?q=${encodeURIComponent(q)}`);
    const data = await res.json();

    hashtagSuggestions.innerHTML = "";
    data.results.forEach(tag => {
      const li = document.createElement("li");
      li.style.cursor = "pointer";
      li.textContent = "#" + tag;
      li.onclick = () => addTag(tag);
      hashtagSuggestions.appendChild(li);
    });
  });
}

function addTag(tag) {
  if (!selectedTags.includes(tag)) {
    selectedTags.push(tag);
    renderTags();
  }
}

function renderTags() {
  selectedDiv.innerHTML = "";
  selectedTags.forEach(tag => {
    const container = document.createElement("span");
    container.className = "selected-tag";
    container.innerHTML = "#" + tag;

    const btn = document.createElement("button");
    btn.innerHTML = "√ó";
    btn.onclick = () => {
      selectedTags = selectedTags.filter(t => t !== tag);
      renderTags();
    };

    container.appendChild(btn);
    selectedDiv.appendChild(container);
  });

  // afficher/cacher le bouton selon le nb de tags
  applyBtn.style.display = selectedTags.length > 0 ? "inline-block" : "none";
}

applyBtn.addEventListener("click", () => {
  if (selectedTags.length === 0) return;
  const param = selectedTags.join(",");
  window.location.href = `/feed?hashtags=${encodeURIComponent(param)}`;
});
</script>

{% endblock %}
