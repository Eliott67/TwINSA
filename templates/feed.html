{% extends "base.html" %}
{% block title %}Feed - TwINSA{% endblock %}

{% block content %}

<style>
  /* --- Notifications sidebar --- */
  .notif-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1100;
    border: none;
    background: #111827;
    color: #f9fafb;
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    cursor: pointer;
    font-size: 1.1rem;
  }

  .notif-sidebar {
    position: fixed;
    top: 0;
    left: -260px;
    width: 260px;
    height: 100vh;
    background: #111827;
    color: #f9fafb;
    padding: 1rem;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    transition: left 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
  }

  .notif-sidebar.open {
    left: 0;
  }
  .hashtag-filter {
    margin: 0.5rem 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .hashtag-chip {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.8rem;
    border-radius: 9999px;
    background: #e5e7eb;
    font-weight: 600;
    margin-right: 0.4rem;
  }

  .clear-filter {
    font-size: 1.2rem;
    text-decoration: none;
    cursor: pointer;
    color: #6b7280;
  }

  .clear-filter:hover {
    color: #111827;
  }

   /* üîπ Panneau de filtres dans le feed */
  .filter-panel {
    max-width: 800px;
    margin: 0.5rem auto 1rem auto;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    font-size: 0.9rem;
    display: none;          /* cach√© par d√©faut */
  }

  .filter-panel.open {
    display: block;
  }

  .filter-form {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .filter-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.4rem;
  }

  .filter-label {
    font-weight: 600;
    margin-right: 0.3rem;
  }

  .filter-separator {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .filter-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    background: #e5e7eb;
    font-size: 0.85rem;
  }

  .filter-chip input[type="radio"],
  .filter-chip input[type="checkbox"] {
    margin: 0;
  }

  .filter-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-top: 0.4rem;
  }

  .btn-clear-filters {
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    border: 1px solid #e5e7eb;
    background: #ffffff;
    font-size: 0.85rem;
    text-decoration: none;
    color: #111827;
  }

  .btn-clear-filters:hover {
    background: #f3f4f6;
  }
  
</style>

<!-- üîî Bell -->
<button class="notif-toggle" id="notifToggle">üîî</button>

<!-- Sidebar -->
<aside class="notif-sidebar" id="notifSidebar">
  <div class="notif-sidebar-header">
    <h3>Notifications</h3>
    <span class="notif-count">{{ notifications|length }}</span>
  </div>

  <ul class="notif-list">
    {% if notifications %}
      {% for n in notifications %}
        <li class="notif-item">{{ n }}</li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No notifications yet.</li>
    {% endif %}
  </ul>

  <div class="notif-sidebar-header" style="margin-top: 1rem;">
    <h3>Pending requests</h3>
    <span class="notif-count">{{ pending_requests|length }}</span>
  </div>

  <ul class="notif-list">
    {% if pending_requests %}
      {% for u in pending_requests %}
        <li class="notif-item">
          {% if u.username is defined %}
            {{ u.username }} wants to follow you
          {% else %}
            {{ u }} wants to follow you
          {% endif %}
        </li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No pending requests.</li>
    {% endif %}
  </ul>
</aside>

<div class="feed-main-with-notifs">

  <!-- üîµ VERSION ORIGINALE DU HEADER, juste Search ‚Üí bleu -->
  <div class="feed-header-top">
    <h2>Welcome, {{ username }} üëã</h2>

    <div class="feed-header-buttons">
      <!-- Search devient bleu : profile-btn -->
      <a href="{{ url_for('search_users') }}" class="btn profile-btn">Search</a>

      <!-- üîµ Nouveau bouton Filter -->
      <button type="button" class="btn profile-btn" id="filterToggle">
        Filter
      </button>

      <!-- Profile reste bleu -->
      <a href="{{ url_for('profile', username=username) }}" class="btn profile-btn">Profile</a>

      <!-- Logout reste normal -->
      <a href="{{ url_for('logout') }}" class="btn logout-btn">Log out</a>
    </div>
  </div>

  <div class="feed-container">

    <form method="POST" class="tweet-form" id="tweetForm" enctype="multipart/form-data">
      <textarea id="tweetBox" name="tweet" maxlength="180" placeholder="What's happening?" required></textarea>
      <input type="file" name="image" accept=".jpg,.jpeg,.png">
      <div class="tweet-footer">
        <span id="charCount">0 / 180</span>
        <button type="submit">Post</button>
      </div>
    </form>

    <hr>

    <!-- üîΩ Petit panneau de filtres (UI seulement) -->
    <div id="filterPanel" class="filter-panel">
      <form method="GET" action="{{ url_for('feed') }}" class="filter-form">
        
        <!-- Type de feed -->
        <div class="filter-row">
          <span class="filter-label">Feed:</span>
          <label class="filter-chip">
            <input 
              type="radio" 
              name="feed_type" 
              value="friends"
              {% if request.args.get('feed_type', 'friends') != 'discover' %}checked{% endif %}
            >
            Friends Feed
          </label>
          <label class="filter-chip">
            <input 
              type="radio" 
              name="feed_type" 
              value="discover"
              {% if request.args.get('feed_type') == 'discover' %}checked{% endif %}
            >
            Discover Feed
          </label>
        </div>

        <!-- P√©riode de temps -->
        <div class="filter-row">
          <span class="filter-label">Date:</span>
          <input type="date" name="start_date" value="{{ request.args.get('start_date', '') }}">
          <span class="filter-separator">to</span>
          <input type="date" name="end_date" value="{{ request.args.get('end_date', '') }}">
        </div>

        <!-- Type de contenu -->
        <div class="filter-row">
          <span class="filter-label">Content:</span>

          <label class="filter-chip">
            <input 
              type="checkbox" 
              name="content_type" 
              value="text"
              {% if 'text' in request.args.getlist('content_type') %}checked{% endif %} 
            >
            Message
          </label>

          <label class="filter-chip">
            <input type="checkbox" name="content_type" value="image"
            {% if 'image' in request.args.getlist('content_type') %}checked{% endif %}
            >
            Image
          </label>

          <label class="filter-chip">
            <input type="checkbox" name="content_type" value="hashtag"
            {% if 'hashtag' in request.args.getlist('content_type') %}checked{% endif %}
          >
            Hashtag
          </label>

          <label class="filter-chip">
            <input type="checkbox" name="content_type" value="emoji"
            {% if 'emoji' in request.args.getlist('content_type') %}checked{% endif %}
          >
            Emoji
          </label>
        </div>

        <!-- Boutons -->
        <div class="filter-actions">
          <!-- Pour l‚Äôinstant, Remove all filters renvoie juste au feed normal -->
          <a href="{{ url_for('feed') }}" class="btn btn-clear-filters">
            Remove all filters
          </a>

          <!-- Save Filters : enverra les param√®tres en GET, on fera la logique apr√®s -->
          <button type="submit" class="btn profile-btn">
            Save Filters
          </button>
        </div>

      </form>
    </div>

    {% if selected_hashtags %}
      <div class="hashtag-filter">
        {% for tag in selected_hashtags %}
          <span class="hashtag-chip">#{{ tag }}</span>
          <a href="{{ unselect_urls[tag] }}" class="clear-filter" title="Remove hashtag">&times;</a>
        {% endfor %}
      </div>
    {% endif %}


    <div class="tweets">
      {% if tweets %}
        {% for tweet in tweets %}
          <div class="tweet">

            <div class="tweet-header">
              <a href="{{ url_for('profile', username=tweet.poster_username) }}">
                <img src="{{ url_for('static', filename='profile_pics/' ~ tweet.poster_pfp) }}"
                class="pfp-small" alt="pfp">
              </a>
              <strong>@{{ tweet.poster_username }}</strong>
            </div>

            <p>{{ tweet.html_content | safe }}</p>            


            {% if tweet.image %}
              <img src="{{ url_for('static', filename='uploads/' ~ tweet.image) }}" 
                 alt="Post image" style="max-width: 300px; display:block; margin-top:0.5rem;">
            {% endif %}    
              

            <small>{{ tweet.date }}</small>

            <div class="tweet-actions">
              <a href="{{ url_for('like', post_index=tweet.index) }}" class="like-btn">
                ‚ù§Ô∏è {{ tweet.likes|length }}
              </a>
              <form action="{{ url_for('delete_post_route', post_index=tweet.index) }}" method="POST" style="display:inline;">
                 <button type="submit" class="delete-btn">üóëÔ∏è Delete</button>
              </form>

              <form action="{{ url_for('edit_post_route', post_index=tweet.index) }}" method="POST" class="edit-form" style="display:none;">
                <input type="text" name="new_content" value="{{ tweet.content }}" maxlength="180" required>
                <button type="submit" class="save-edit-btn">üíæ Save</button>
              </form>

              <button class="edit-btn" onclick="toggleEdit(this)">‚úèÔ∏è Edit</button>

              
            </div>

            <div class="tweet-comments">
              {% if tweet.comments %}
                {% for c in tweet.comments %}
                  <div class="comment">
                    <div class="comment-header">
                      <strong>@{{ c.username }}</strong>
                      {% if c.username == username %}
                        <a href="{{ url_for('delete_comment', post_index=tweet.index, comment_index=loop.index0) }}" class="delete-comment">üóëÔ∏è</a>
                      {% endif %}
                    </div>
                    <p>{{ c.comment }}</p>
                    <small>{{ c.date }}</small>
                  </div>
                {% endfor %}
              {% endif %}

              <form action="{{ url_for('comment', post_index=tweet.index) }}" method="POST" class="comment-form">
                <input type="text" name="comment" placeholder="Add a comment..." maxlength="120">
                <button type="submit" class="comment-btn">üí¨</button>
              </form>
            </div>

          </div>
        {% endfor %}
      {% else %}
        <p>No posts yet. Be the first to post!</p>
      {% endif %}
    </div>

  </div>
</div>

<script>
  // Sidebar toggle
  const notifToggle = document.getElementById('notifToggle');
  const notifSidebar = document.getElementById('notifSidebar');

  notifToggle.addEventListener('click', () => {
    notifSidebar.classList.toggle('open');
  });

  // Toggle du panneau de filtres
  const filterToggle = document.getElementById("filterToggle");
  const filterPanel = document.getElementById("filterPanel");

  if (filterToggle && filterPanel) {
    filterToggle.addEventListener("click", () => {
      filterPanel.classList.toggle("open");
    });
  }

  // Char count
  const tweetBox = document.getElementById('tweetBox');
  const charCount = document.getElementById('charCount');

  tweetBox.addEventListener('input', () => {
    charCount.textContent = tweetBox.value.length + " / 180";
  });
</script>

<script>
function toggleEdit(btn) {
  const tweet = btn.closest(".tweet");
  const form = tweet.querySelector(".edit-form");
  form.style.display = form.style.display === "none" ? "block" : "none";
}
</script>

{% endblock %}
