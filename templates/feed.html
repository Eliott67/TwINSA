{% extends "base.html" %}
{% block title %}Feed - TwINSA{% endblock %}

{% block content %}


<style>
  /* --- Notifications sidebar --- */
  .notif-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1100;
    border: none;
    background: #111827;
    color: #f9fafb;
    padding: 0.4rem 0.8rem;
    border-radius: 999px;
    cursor: pointer;
    font-size: 1.1rem;
  }

  .notif-sidebar {
    position: fixed;
    top: 0;
    left: -260px;
    width: 260px;
    height: 100vh;
    background: #111827;
    color: #f9fafb;
    padding: 1rem;
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    transition: left 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
  }

  .notif-sidebar.open {
    left: 0;
  }

  .notif-sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .notif-sidebar-header h3 {
    margin: 0;
    font-size: 1.1rem;
  }

  .notif-count {
    background: #f97316;
    border-radius: 999px;
    padding: 0.1rem 0.6rem;
    font-size: 0.8rem;
  }

  .notif-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .notif-item {
    padding: 0.6rem 0.4rem;
    border-bottom: 1px solid rgba(249,250,251,0.1);
    font-size: 0.9rem;
    line-height: 1.3;
  }

  .notif-item:last-child {
    border-bottom: none;
  }

  .notif-empty {
    padding: 0.4rem;
    font-size: 0.9rem;
    color: #9ca3af;
  }

  .feed-main-with-notifs {
    padding-left: 3.5rem;
  }

  @media (max-width: 600px) {
    .feed-main-with-notifs {
      padding-left: 3rem;
    }
  }

  /* --- Search √† gauche + Welcome centr√© --- */
  .feed-header-row {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
  }

  /* Search reste √† gauche naturellement */
  .feed-header-row .search-btn-top {
    /* tu peux rajouter du style si besoin */
  }

  /* Welcome prend tout l‚Äôespace restant et se centre */
  .welcome-title {
    flex: 1;
    margin: 0;
    text-align: center;
  }

  /* Bloc vide √† droite avec m√™me largeur approx. que le bouton Search
     pour garder le vrai centrage */
  .header-right-space {
    width: 90px; /* ajuste si ton bouton est plus large/√©troit */
  }

</style>


<!-- üîî Bell to open the sidebar -->
<button class="notif-toggle" id="notifToggle">üîî</button>

<!-- Left sliding sidebar -->
<aside class="notif-sidebar" id="notifSidebar">
  <div class="notif-sidebar-header">
    <h3>Notifications</h3>
    <span class="notif-count">{{ notifications|length }}</span>
  </div>

  <ul class="notif-list">
    {% if notifications %}
      {% for n in notifications %}
        <li class="notif-item">{{ n }}</li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No notifications yet.</li>
    {% endif %}
  </ul>

  <div class="notif-sidebar-header" style="margin-top: 1rem;">
    <h3>Pending requests</h3>
    <span class="notif-count">{{ pending_requests|length }}</span>
  </div>

  <ul class="notif-list">
    {% if pending_requests %}
      {% for u in pending_requests %}
        <li class="notif-item">
          {% if u.username is defined %}
            {{ u.username }} wants to follow you
          {% else %}
            {{ u }} wants to follow you
          {% endif %}
        </li>
      {% endfor %}
    {% else %}
      <li class="notif-empty">No pending requests.</li>
    {% endif %}
  </ul>

</aside>

<div class="feed-main-with-notifs">

  <!-- HEADER : Search √† gauche + Welcome centr√© -->
  <div class="feed-header-top">

    <div class="feed-header-row">
      <!-- Search √† gauche -->
      <a href="{{ url_for('search_users') }}" class="btn profile-btn search-btn-top">Search</a>

      <!-- Welcome centr√© (gr√¢ce √† flex:1 + text-align:center) -->
      <h2 class="welcome-title">Welcome, {{ username }} üëã</h2>

      <!-- Espace vide √† droite pour √©quilibrer -->
      <div class="header-right-space"></div>
    </div>

    <!-- boutons Profile + Logout en dessous -->
    <div class="feed-header-buttons" style="margin-top: 10px;">
      <a href="{{ url_for('profile', username=username) }}" class="btn profile-btn">Profile</a>
      <a href="{{ url_for('logout') }}" class="btn logout-btn">Log out</a>
    </div>

  </div>

  <div class="feed-container">

    <form method="POST" class="tweet-form" id="tweetForm">
      <textarea id="tweetBox" name="tweet" maxlength="180" placeholder="What's happening?" required></textarea>
      <div class="tweet-footer">
        <span id="charCount">0 / 180</span>
        <button type="submit">Post</button>
      </div>
    </form>

    <hr>

    <div class="tweets">
      {% if tweets %}
        {% for tweet in tweets %}
          {% set _ = tweet.update({'index': loop.index0}) %}
          <div class="tweet">
            <strong>@{{ tweet.poster_username }}</strong>
            <p>{{ tweet.content }}</p>
            <small>{{ tweet.date }}</small>

            <div class="tweet-actions">
              <a href="{{ url_for('like', post_index=loop.index0) }}" class="like-btn">
                ‚ù§Ô∏è {{ tweet.likes|length }}
              </a>
              <button class="edit-btn">‚úèÔ∏è Edit</button>
              <button class="delete-btn">üóëÔ∏è Delete</button>
            </div>

            <div class="tweet-comments">
              {% if tweet.comments %}
                {% for c in tweet.comments %}
                  <div class="comment">
                    <div class="comment-header">
                      <strong>@{{ c.username }}</strong>
                      {% if c.username == username %}
                        <a href="{{ url_for('delete_comment', post_index=tweet.index, comment_index=loop.index0) }}" class="delete-comment">üóëÔ∏è</a>
                      {% endif %}
                    </div>
                    <p>{{ c.comment }}</p>
                    <small>{{ c.date }}</small>
                  </div>
                {% endfor %}
              {% endif %}

              <form action="{{ url_for('comment', post_index=loop.index0) }}" method="POST" class="comment-form">
                <input type="text" name="comment" placeholder="Add a comment..." maxlength="120">
                <button type="submit" class="comment-btn">üí¨</button>
              </form>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p>No posts yet. Be the first to post!</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  const notifToggle = document.getElementById('notifToggle');
  const notifSidebar = document.getElementById('notifSidebar');

  if (notifToggle && notifSidebar) {
    notifToggle.addEventListener('click', () => {
      notifSidebar.classList.toggle('open');
    });
  }

  const tweetBox = document.getElementById('tweetBox');
  const charCount = document.getElementById('charCount');

  tweetBox.addEventListener('input', () => {
    const length = tweetBox.value.length;
    charCount.textContent = `${length} / 180`;
    charCount.style.color = length > 160 ? '#ff4d4d' : '#aaa';
  });

  document.querySelectorAll('.tweet').forEach(tweetDiv => {
    const contentP = tweetDiv.querySelector('p');
    const editBtn = tweetDiv.querySelector('.edit-btn');
    const deleteBtn = tweetDiv.querySelector('.delete-btn');

    if (editBtn) {
      editBtn.addEventListener('click', () => {
        const newContent = prompt("Edit your post:", contentP.textContent);
        if (newContent !== null && newContent.trim() !== "") {
          contentP.textContent = newContent;
          alert("Post mis √† jour !");
        }
      });
    }

    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (confirm("Confirmez la suppression ?")) {
          tweetDiv.remove();
          alert("Post supprim√© !");
        }
      });
    }
  });
</script>

{% endblock %}
