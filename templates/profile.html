{% extends "base.html" %}
{% block title %}Profile - TwINSA{% endblock %}

{% block content %}
<div class="profile-container">

{% if current_user.username == user.username %}
  <!-- === PROFILE OWNER VIEW === -->
  <div class="profile-header">
    <h2>Your Profile</h2>
    <a href="{{ url_for('feed') }}" class="btn back-btn">â† Back to Feed</a>
  </div>

  <div class="profile-picture-box">
    {% if user.profile_picture %}
        <img src="{{ url_for('static', filename='profile_pics/' ~ user.profile_picture) }}" class="profile-picture">
    {% else %}
        <img src="{{ url_for('static', filename='default_pfp.png') }}" class="profile-picture">
    {% endif %}
  </div>

  <!-- USER INFO -->
  <div class="profile-info">
    <p>ğŸ‘¤ <strong>Username:</strong> @{{ user.username }}</p>
    <p>ğŸ“› <strong>Name:</strong> {{ user.name }}</p>
    <p>ğŸ‚ <strong>Age:</strong> {{ user.age }}</p>
    <p>ğŸŒ <strong>Country:</strong> {{ user.country }}</p>
    <p>ğŸ”’ <strong>Public profile:</strong> {{ 'Yes' if user.is_public else 'No' }}</p>
  </div>

  <div class="follow-counts">
        <a href="{{ url_for('view_followers', username=user.username) }}" class="follow-link">
            ğŸ‘¥ Followers: <strong>{{ followers|length }}</strong>
        </a>

        <a href="{{ url_for('view_following', username=user.username) }}" class="follow-link">
            â¡ï¸ Following: <strong>{{ following|length }}</strong>
        </a>
  </div>

  <!-- POSTS -->
  <div class="profile-posts">
    <h3>--- Posts ---</h3>

    {% if not visible %}
      <p>No posts yet.</p>
    {% else %}
      <ul>
        {% for post in visible %}
          <li class="post-item">
              <div class="post-header">
                  <strong>@{{ post.poster_username }}</strong>
                  <span class="post-date">{{ post.date.strftime('%Y-%m-%d %H:%M') }}</span>
              </div>

              <div class="post-content">
                  {{ post.content }}
                  {% if post.image %}
                    <img src="{{ url_for('static', filename='uploads/' ~ post.image) }}" class="post-image">
                  {% endif %}

              </div>

              <div class="post-stats">
                  â¤ï¸ {{ post.likes|length }} â€¢ ğŸ’¬ {{ post.comments|length }}
              </div>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
    

  <!-- BOUTON MODIFIER MON PROFIL -->
    <!-- Bouton Modifier mon profil -->
    <div class="center-button">
      <a href="{{ url_for('edit_profile2', username=user.username) }}" class="btn-edit-profile">
        âœï¸ Edit profile
      </a>
    </div> 



{% else %}
  <!-- === VIEWING ANOTHER USER'S PROFILE === -->
  <div class="profile-header">
    <h2>{{ user.username }}'s Profile</h2>
    <a href="{{ url_for('search_users') }}" class="btn back-btn">â† Back to Search</a>
  </div>

  <div class="profile-picture-box">
    {% if user.profile_picture %}
        <img src="{{ url_for('static', filename='profile_pics/' ~ user.profile_picture) }}" class="profile-picture">
    {% else %}
        <img src="{{ url_for('static', filename='default_pfp.png') }}" class="profile-picture">
    {% endif %}
  </div>

  {% if can_view %}
      <div class="profile-info">
        <p>ğŸ‘¤ <strong>Username:</strong> @{{ user.username }}</p>
        <p>ğŸ“› <strong>Name:</strong> {{ user.name }}</p>
        <p>ğŸ‚ <strong>Age:</strong> {{ user.age }}</p>
        <p>ğŸŒ <strong>Country:</strong> {{ user.country }}</p>
        <p>ğŸ”’ <strong>Public profile:</strong> {{ 'Yes' if user.is_public else 'No' }}</p>
      </div>

      <div class="follow-counts">
          <a href="{{ url_for('view_followers', username=user.username) }}" class="follow-link">
              ğŸ‘¥ Followers: <strong>{{ followers|length }}</strong>
          </a>

          <a href="{{ url_for('view_following', username=user.username) }}" class="follow-link">
              â¡ï¸ Following: <strong>{{ following|length }}</strong>
          </a>
      </div>

      <!-- POSTS -->
      
      <div class="profile-posts">
    <h3>--- Posts ---</h3>

        {% if visible|length == 0 %}
          <p>No posts yet.</p>
        {% else %}
          <ul>
            {% for post in visible %}
              <li class="post-item">
                  <div class="post-header">
                      <strong>@{{ post.poster_username }}</strong>
                      <span class="post-date">{{ post.date.strftime('%Y-%m-%d %H:%M') }}</span>
                  </div>

                  <div class="post-content">
                      {{ post.content }}
                      {% if post.image %}
                        <img src="{{ url_for('static', filename='uploads/' ~ post.image) }}" class="post-image">
                      {% endif %}
                  </div>

                  <div class="post-stats">
                      â¤ï¸ {{ post.likes|length }} â€¢ ğŸ’¬ {{ post.comments|length }}
                  </div>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="profile-actions">
      {% if current_user.follows(user) %}
        <form action="{{ url_for('unfollow_user', username=user.username) }}" method="POST">
          <button type="submit" class="btn">Unfollow</button>
        </form>
      {% else %}
        <form action="{{ url_for('follow_user', username=user.username) }}" method="POST">
          <button type="submit" class="btn">Follow</button>
        </form>
      {% endif %}

    {% else %}
      
      <p>This account is private. Follow the user to see more information.</p>
    <div class="profile-actions">
      <form action="{{ url_for('send_follow_request', username=user.username) }}" method="POST">
        <button type="submit" class="btn">Send Follow Request</button>
      </form>

    {% endif %}

      {% if current_user.blocks(user) %}
        <form action="{{ url_for('unblock_user', username=user.username) }}" method="POST">
          <button type="submit" class="btn">Unblock</button>
        </form>
      {% else %}
        <form action="{{ url_for('block_user', username=user.username) }}" method="POST">
          <button type="submit" class="btn">Block</button>
        </form>
      {% endif %}
    </div>
  {% endif %}

</div>
{% endblock %}